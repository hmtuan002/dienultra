<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebRTC Screen Share</title>
</head>
<body>
  <h1>Chia s·∫ª m√†n h√¨nh</h1>
  <button id="shareBtn">B·∫Øt ƒë·∫ßu chia s·∫ª m√†n h√¨nh</button>
  <p>N·∫øu b·∫°n kh√¥ng chia s·∫ª m√†n h√¨nh, b·∫°n s·∫Ω th·∫•y m√†n h√¨nh c·ªßa ng∆∞·ªùi kh√°c.</p>

  <video id="localVideo" autoplay muted playsinline style="width: 400px; display: none; border: 1px solid gray;"></video>
  <video id="remoteVideo" autoplay playsinline style="width: 100%; border: 2px solid black;"></video>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

  <script>
    // ‚úÖ Firebase config c·ªßa b·∫°n
    const firebaseConfig = {
      apiKey: "AIzaSyAykZJk8SDDco7ebgVOGUcOM7NTpralBKM",
      authDomain: "gayss-c8d12.firebaseapp.com",
      databaseURL: "https://gayss-c8d12-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "gayss-c8d12",
      storageBucket: "gayss-c8d12.firebasestorage.app",
      messagingSenderId: "1041137167845",
      appId: "1:1041137167845:web:3101f7d2ed9c602b9f530c",
      measurementId: "G-P767X2ZLTB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const roomRef = db.ref("room");

    const shareBtn = document.getElementById('shareBtn');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    let isSharer = false;
    let pc = new RTCPeerConnection({
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }
      ]
    });

    // üîÅ ICE Candidate exchange
    pc.onicecandidate = event => {
      if (event.candidate) {
        roomRef.child("ice").push(JSON.stringify(event.candidate));
      }
    };

    // üëÄ Khi nh·∫≠n ƒë∆∞·ª£c stream t·ª´ ng∆∞·ªùi chia s·∫ª
    pc.ontrack = event => {
      if (remoteVideo.srcObject !== event.streams[0]) {
        remoteVideo.srcObject = event.streams[0];
      }
    };

    // üë®‚Äçüè´ Ng∆∞·ªùi chia s·∫ª m√†n h√¨nh
    shareBtn.onclick = async () => {
      isSharer = true;
      const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
      localVideo.srcObject = stream;
      localVideo.style.display = 'block';

      stream.getTracks().forEach(track => pc.addTrack(track, stream));

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await roomRef.child("offer").set(JSON.stringify(offer));
    };

    // üëÄ Ng∆∞·ªùi xem (t·ª± ƒë·ªông nh·∫≠n offer n·∫øu c√≥)
    roomRef.child("offer").on("value", async snapshot => {
      const offer = snapshot.val();
      if (!offer || isSharer || pc.currentRemoteDescription) return;

      await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(offer)));

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await roomRef.child("answer").set(JSON.stringify(answer));
    });

    // Ng∆∞·ªùi chia s·∫ª nh·∫≠n answer t·ª´ viewer
    roomRef.child("answer").on("value", async snapshot => {
      const answer = snapshot.val();
      if (!answer || !isSharer || pc.currentRemoteDescription) return;

      await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(answer)));
    });

    // üîÅ Nh·∫≠n ICE Candidates t·ª´ peer
    roomRef.child("ice").on("child_added", async snapshot => {
      const candidate = JSON.parse(snapshot.val());
      if (candidate) {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(candidate));
        } catch (e) {
          console.error("L·ªói th√™m ICE:", e);
        }
      }
    });
  </script>
</body>
</html>
